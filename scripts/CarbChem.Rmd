---
title: "Carbonate Chemistry"
author: "jillashey"
date: "2023-06-09"
output: html_document
---

This script will calculate various carbonate chemistry parameters for the Hawaii 2022 experimental dataset. Using scripts from [Sam Gurr](https://github.com/SamGurr/Geoduck_transgen_offspring_OA/blob/master/RAnalysis/Scripts/CarbChem.R) and [Emma Strand](https://github.com/hputnam/Acclim_Dynamics/blob/master/Scripts/CarbChem.Rmd)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load packages 
```{r}
library(tidyverse)
library(multcomp)
library(car)
library(readxl)
library(seacarb)
library(cowplot)
library(dplyr)
library(ggpubr)
library(ggstatsplot)
library(wesanderson)
library(ggsignif)
library(dunn.test)
library(kableExtra)
library(webshot2)
library(magick)
```

# Discrete pH calculations

## Read in tris calibration information and calculate slope and intercept 
```{r}
path <-("../Raw_data/pH_tris")
file.names<-list.files(path = path, pattern = "csv$") #list all the file names in the folder to get only get the csv files
pH.cals <- data.frame(matrix(NA, nrow=length(file.names), ncol=3, dimnames=list(file.names,c("Date", "Intercept", "Slope")))) #generate a 3 column dataframe with specific column names

for(i in 1:length(file.names)) { # for every file in list start at the first and run this following function
  Calib.Data <-read.table(file.path(path,file.names[i]), header=TRUE, sep=",", na.string="NA", as.is=TRUE) #reads in the data files
  model <-lm(mVTris ~ TTris, data=Calib.Data) #runs a linear regression of mV as a function of temperature
  coe <- coef(model) #extracts the coeffecients
  summary(model)$r.squared
  plot(Calib.Data$mVTris, Calib.Data$TTris)
  pH.cals[i,2:3] <- coe #inserts them in the dataframe
  pH.cals[i,1] <- substr(file.names[i],1,8) #stores the file name in the Date column
}
colnames(pH.cals) <- c("Calib.Date",  "Intercept",  "Slope") #rename columns
pH.cals

#constants for use in pH calculation 
R <- 8.31447215 #gas constant in J mol-1 K-1 
F <-96485.339924 #Faraday constant in coulombs mol-1
```

## Read in daily measurements
```{r}
daily <- read.csv("../Raw_data/Water_chemistry_OrionStar_TA.csv")[,1:10]
daily <- na.omit(daily)
```

## Merge daily measurements w/ pH tris 
```{r}
SW.chem <- merge(pH.cals, daily, by = "Calib.Date")
```

## Calculate total pH
```{r}
mvTris <- SW.chem$temp*SW.chem$Slope+SW.chem$Intercept #calculate the mV of the tris standard using the temperature mv relationships in the measured standard curves 
STris<-34.5 #salinity of the Tris
phTris<- (11911.08-18.2499*STris-0.039336*STris^2)*(1/(SW.chem$temp+273.15))-366.27059+ 0.53993607*STris+0.00016329*STris^2+(64.52243-0.084041*STris)*log(SW.chem$temp+273.15)-0.11149858*(SW.chem$temp+273.15) #calculate the pH of the tris (Dickson A. G., Sabine C. L. and Christian J. R., SOP 6a)
SW.chem$pH.Total<-phTris+(mvTris/1000-SW.chem$pH_mV/1000)/(R*(SW.chem$temp+273.15)*log(10)/F) #calculate the pH on the total scale (Dickson A. G., Sabine C. L. and Christian J. R., SOP 6a)
```

# Discrete TA calculations
```{r}
TA <- read.csv("../Raw_data/TA/Cumulative_TA_Output.csv")
TA$SampleID <- gsub("^[^_]*_", "", TA$SampleID) # remove 1_ or 2_ from sample ID
TA <- TA %>%
  filter(Type == "Sample") %>%
  mutate(Treatment = case_when(
    startsWith(SampleID, "C") ~ "Control",
    startsWith(SampleID, "M") ~ "Mid",
    startsWith(SampleID, "H") ~ "High"
  ))
```

## Examine for outliers 
```{r}
ggplot(TA, aes(x = Treatment, y = TA)) +
  geom_boxplot()

#identify outliers by Treatment groups and sample rep
outlier.plot <- ggbetweenstats(TA, Treatment, TA, outlier.tagging = TRUE)
outlier.plot
```

## Remove outliers
```{r}
#set quantile values
q <- c(0.25, 0.75)

# calculate quantile values by Temperature and Treatment groups
Quants <- TA %>%
  group_by(Treatment) %>%
  summarize(quant25 = quantile(TA, probs = q[1]),
            quant75 = quantile(TA, probs = q[2]),
            IQRbyGroup=IQR(TA))

#Calculate Quantile upper and lower ranges 
Quants$upper <-  Quants$quant75+1.5*Quants$IQRbyGroup # Upper Range  
Quants$lower <- Quants$quant25-1.5*Quants$IQRbyGroup # Lower Range

#Calculate STDev upper and lower ranges 
Quants$upper.stdev <- mean(TA$TA)+(sd(TA$TA)*2) # Upper Range  
Quants$lower.stdev <- mean(TA$TA)-(sd(TA$TA)*2) # Lower Range

#join outlier cutoffs with rate data
TAdata <- left_join(TA, Quants)

#remove outliers from rates
TAdata <- TAdata %>%
   filter(TA < upper) %>%
   filter(TA > lower)

# Plot TA value by treatment 
ggplot(TAdata, aes(x = Treatment, y = TA)) +
  geom_boxplot()

# Remove outliers from high trt (rows 82 and 166)
TAdata <- TAdata[-c(82,166),]

# Plot TA value by treatment 
ggplot(TAdata, aes(x = Treatment, y = TA)) +
  geom_boxplot()

#remove excess data columns
TAdata <- TAdata %>% 
  dplyr::select(c("SampleID","TA","Salinity", "Date"))
```

## Calculate mean of duplicate samples 
```{r}
TA_mean <- TAdata %>%
  group_by(SampleID) %>%
  summarise(mean_TA = mean(TA), .groups = "drop")
  
Sal_mean <- TAdata %>%
  group_by(SampleID) %>%
  summarise(mean_Sal = mean(Salinity), .groups = "drop")
```

## Merge calculated pH and daily measurements with TA data 
```{r}
# Merge seawater chemistry with total alkalinity
SW.chem <- merge(SW.chem, TA_mean, by="SampleID", all = TRUE, sort = T) 

# Merge seawater chemistry w/ salinity from TA measurements 
SW.chem <- merge(SW.chem, Sal_mean, by="SampleID", all = TRUE, sort = T)

# Remove NAs
SW.chem <- na.omit(SW.chem)
```

## Select specific columns 
```{r}
SW.chem <- SW.chem %>%
  dplyr::select(SampleID, Date, Time, tank, squaricle, temp, pH.Total, mean_TA, mean_Sal) %>%
  rename("Treatment" = "tank", 
         "Temperature" = "temp", 
         "TA" = "mean_TA",
         "Salinity" = "mean_Sal")
```

## Make outlier plots 
```{r}
# Temperature
outlier.plot <- ggbetweenstats(SW.chem, Treatment, Temperature, outlier.tagging = TRUE)
outlier.plot # outliers present

# pH total
outlier.plot <- ggbetweenstats(SW.chem, Treatment, pH.Total, outlier.tagging = TRUE)
outlier.plot # outliers present 

# Salinity
outlier.plot <- ggbetweenstats(SW.chem, Treatment, Salinity, outlier.tagging = TRUE)
outlier.plot

# TA
outlier.plot <- ggbetweenstats(SW.chem, Treatment, TA, outlier.tagging = TRUE)
outlier.plot
```

## Remove outliers from temp and pH data.
```{r}
### Temperature 
#set quantile values
q <- c(0.25, 0.75)

# calculate quantile values by Treatment groups
Quants <- SW.chem %>%
  group_by(Treatment) %>%
  summarize(quant25 = quantile(Temperature, probs = q[1]),
            quant75 = quantile(Temperature, probs = q[2]),
            IQRbyGroup=IQR(Temperature))

#Calculate Quantile upper and lower ranges 
Quants$upper <-  Quants$quant75+1.5*Quants$IQRbyGroup # Upper Range  
Quants$lower <- Quants$quant25-1.5*Quants$IQRbyGroup # Lower Range

#Calculate STDev upper and lower ranges 
Quants$upper.stdev <- mean(SW.chem$Temperature)+(sd(SW.chem$Temperature)*2) # Upper Range  
Quants$lower.stdev <- mean(SW.chem$Temperature)-(sd(SW.chem$Temperature)*2) # Lower Range

#join outlier cutoffs with rate data
data <- left_join(SW.chem, Quants)

#remove outliers from rates
data <- data %>%
   filter(Temperature < upper) %>%
   filter(Temperature > lower)

# Plot temp value by treatment 
ggplot(data, aes(x = Treatment, y = Temperature)) +
  geom_boxplot()

#remove excess data columns
data <- data %>% 
  dplyr::select(c("SampleID","Date","Treatment", "squaricle", "Temperature", "pH.Total", "TA", "Salinity"))



### pH total 
#set quantile values
q <- c(0.25, 0.75)

# calculate quantile values by Treatment groups
Quants <- data %>%
  group_by(Treatment) %>%
  summarize(quant25 = quantile(pH.Total, probs = q[1]),
            quant75 = quantile(pH.Total, probs = q[2]),
            IQRbyGroup=IQR(pH.Total))

#Calculate Quantile upper and lower ranges 
Quants$upper <-  Quants$quant75+1.5*Quants$IQRbyGroup # Upper Range  
Quants$lower <- Quants$quant25-1.5*Quants$IQRbyGroup # Lower Range

#Calculate STDev upper and lower ranges 
Quants$upper.stdev <- mean(data$pH.Total)+(sd(data$pH.Total)*2) # Upper Range  
Quants$lower.stdev <- mean(data$pH.Total)-(sd(data$pH.Total)*2) # Lower Range

#join outlier cutoffs with rate data
data <- left_join(data, Quants)

#remove outliers from rates
data <- data %>%
   filter(pH.Total < upper) %>%
   filter(pH.Total > lower)

# Plot pH value by treatment 
ggplot(data, aes(x = Treatment, y = pH.Total)) +
  geom_boxplot()

#remove excess data columns
data <- data %>% 
  dplyr::select(c("SampleID","Date","Treatment", "squaricle", "Temperature", "pH.Total", "TA", "Salinity"))

# Rename data to SWchem
SW.chem <- data
```

## Calculate CO2 parameters using seacarb 
```{r}
carb.output <- seacarb::carb(flag=8, var1=SW.chem$pH.Total, var2=SW.chem$TA/1000000, S= SW.chem$Salinity, T=SW.chem$Temperature, P=0, Pt=0, Sit=0, pHscale="T", kf="pf", k1k2="l", ks="d") #calculate seawater chemistry parameters using seacarb
carb.output$ALK <- carb.output$ALK*1000000 #convert to µmol kg-1
carb.output$CO2 <- carb.output$CO2*1000000 #convert to µmol kg-1
carb.output$HCO3 <- carb.output$HCO3*1000000 #convert to µmol kg-1
carb.output$CO3 <- carb.output$CO3*1000000 #convert to µmol kg-1
carb.output$DIC <- carb.output$DIC*1000000 #convert to µmol kg-1
carb.output <- carb.output[,-c(1,4,5,8,10:13,19)] #subset variables of interest

# bind SW chem info 
carb.output <- cbind(SW.chem$SampleID, SW.chem$Date, SW.chem$Treatment, SW.chem$squaricle, carb.output)
colnames(carb.output) <- c("SampleID", "Date", "Treatment", "Squaricle", "Salinity", "Temperature", "pH.Total", "CO2", "pCO2", "HCO3", "CO3", "DIC", "TA", "AragSat")

# Arrange treatment order 
carb.output$Treatment <- factor(carb.output$Treatment, levels = c("C", "M", "H"))
```

# Run ANOVA for each parameter 
```{r}
## Test for differences in salinity by treatment with one-way ANOVA
res.aov <- aov(Salinity ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(Salinity ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance 

## Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(Temperature ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(Temperature ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance 

## Test for differences in pH by treatment with one-way ANOVA
res.aov <- aov(pH.Total ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(pH.Total ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance 
## Test for differences in CO2 by treatment with one-way ANOVA
res.aov <- aov(CO2 ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(CO2 ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance --NOT HOMOGENOUS

## Test for differences in pCO2 by treatment with one-way ANOVA
res.aov <- aov(pCO2 ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(pCO2 ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance --NOT HOMOGENOUS

## Test for differences in HCO3 by treatment with one-way ANOVA
res.aov <- aov(HCO3 ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(HCO3 ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance 

## Test for differences in CO3 by treatment with one-way ANOVA
res.aov <- aov(CO3 ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(CO3 ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance 

## Test for differences in DIC by treatment with one-way ANOVA
res.aov <- aov(DIC ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(DIC ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance 

## Test for differences in TA by treatment with one-way ANOVA
res.aov <- aov(TA ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(TA ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance 

## Test for differences in AragSat by treatment with one-way ANOVA
res.aov <- aov(AragSat ~ Treatment, data = carb.output)
summary(res.aov)
TukeyHSD(res.aov) # See if there is any differences between specific treatments 
plot(res.aov, 1) # Check ANOVA assumptions of normality 
leveneTest(AragSat ~ Treatment, data = carb.output) # Check ANOVA assumptions of homogenity of variance 
```

# Plot by parameter
```{r}
# Salinity
compare_means(Salinity ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

sal_plot <- ggplot(carb.output, aes(x = Treatment, y = Salinity, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 36.4) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("Salinity (psu)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
sal_plot

# Temperature
compare_means(Temperature ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

temp_plot <- ggplot(carb.output, aes(x = Treatment, y = Temperature, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 34) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("Temperature (°C)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
temp_plot

# pH
compare_means(pH.Total ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

pH_plot <- ggplot(carb.output, aes(x = Treatment, y = pH.Total, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 8.2) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("pH (total)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
pH_plot

# CO2
compare_means(CO2 ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

CO2_plot <- ggplot(carb.output, aes(x = Treatment, y = CO2, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 57) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("CO2 (µmol kg-1)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
CO2_plot

# pCO2
compare_means(pCO2 ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

pCO2_plot <- ggplot(carb.output, aes(x = Treatment, y = pCO2, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 2200) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("pCO2 (µmol kg-1)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
pCO2_plot

# HCO3
compare_means(HCO3 ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

HCO3_plot <- ggplot(carb.output, aes(x = Treatment, y = HCO3, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 2100) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("HCO3 (µmol kg-1)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
HCO3_plot

# CO3
compare_means(CO3 ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

CO3_plot <- ggplot(carb.output, aes(x = Treatment, y = CO3, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 220) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("CO3 (µmol kg-1)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
CO3_plot

# DIC
compare_means(DIC ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

DIC_plot <- ggplot(carb.output, aes(x = Treatment, y = DIC, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 2200) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("DIC (µmol kg-1)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
DIC_plot

# TA
compare_means(TA ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

TA_plot <- ggplot(carb.output, aes(x = Treatment, y = TA, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 2240) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("TA (µmol kg-1)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
TA_plot

# AragSat
compare_means(AragSat ~ Treatment, data = carb.output, method = "anova")
my_comparisons <- list(c("C", "M"), c("C", "H"), c("M", "H"))

AragSat_plot <- ggplot(carb.output, aes(x = Treatment, y = AragSat, fill = Treatment)) +
  #geom_hline(yintercept=0, linetype="dashed", color="black", size=0.75)+
  geom_boxplot() +
  stat_compare_means(method = "anova", label.y = 3.8) +
  stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  ylab(expression(bold(paste("Aragonite Saturation")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") 
AragSat_plot
```

Double check all parameters for outliers 
```{r}
# Salinity
outlier.plot <- ggbetweenstats(carb.output, Treatment, Salinity, outlier.tagging = TRUE)
outlier.plot

# Temperature
outlier.plot <- ggbetweenstats(carb.output, Treatment, Temperature, outlier.tagging = TRUE)
outlier.plot

# pH
outlier.plot <- ggbetweenstats(carb.output, Treatment, pH.Total, outlier.tagging = TRUE)
outlier.plot

# CO2
outlier.plot <- ggbetweenstats(carb.output, Treatment, CO2, outlier.tagging = TRUE)
outlier.plot

# pCO2
outlier.plot <- ggbetweenstats(carb.output, Treatment, pCO2, outlier.tagging = TRUE)
outlier.plot

# HCO3
outlier.plot <- ggbetweenstats(carb.output, Treatment, HCO3, outlier.tagging = TRUE)
outlier.plot

# CO3
outlier.plot <- ggbetweenstats(carb.output, Treatment, CO3, outlier.tagging = TRUE)
outlier.plot

# DIC
outlier.plot <- ggbetweenstats(carb.output, Treatment, DIC, outlier.tagging = TRUE)
outlier.plot

# TA
outlier.plot <- ggbetweenstats(carb.output, Treatment, TA, outlier.tagging = TRUE)
outlier.plot

# AragSat
outlier.plot <- ggbetweenstats(carb.output, Treatment, AragSat, outlier.tagging = TRUE)
outlier.plot
```

Save plots
```{r}
#all_plots<-plot_grid(sal_plot, temp_plot, pH_plot, CO2_plot, pCO2_plot, HCO3_plot, CO3_plot, DIC_plot, TA_plot, AragSat_plot, nrow=2, ncol=5, label_y=1, labels=c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J"), label_size=18)

#ggsave(all_plots, file="output/CarbChem/CarbChem_panel.png", width=25, height=10)
```

```{r}
#write.csv(carb.output, "output/CarbChem/CarbChem.csv")
```

## Remake figures for publication 

Read in data 
```{r}
data <- read.csv("../output/CarbChem/CarbChem.csv")
data <- data[,-1]

# Change C = Control, M = Mid, H = High
data <- data %>%
  mutate(Treatment = ifelse(Treatment == "C", "Control", Treatment)) %>%
  mutate(Treatment = ifelse(Treatment == "M", "Mid", Treatment)) %>%
  mutate(Treatment = ifelse(Treatment == "H", "High", Treatment))

# Set variables as factors 
data$Treatment <- factor(data$Treatment, levels = c("Control", "Mid", "High"))
```

Look at min and max values for each parameter per treatment
```{r}
result <- data %>%
  group_by(Treatment) %>% # Group by Treatment
  summarize(
    min_Salinity = min(Salinity, na.rm = TRUE),
    max_Salinity = max(Salinity, na.rm = TRUE),
    min_Temperature = min(Temperature, na.rm = TRUE),
    max_Temperature = max(Temperature, na.rm = TRUE),
    min_pH_Total = min(pH.Total, na.rm = TRUE),
    max_pH_Total = max(pH.Total, na.rm = TRUE),
    min_CO2 = min(CO2, na.rm = TRUE),
    max_CO2 = max(CO2, na.rm = TRUE),
    min_pCO2 = min(pCO2, na.rm = TRUE),
    max_pCO2 = max(pCO2, na.rm = TRUE),
    min_HCO3 = min(HCO3, na.rm = TRUE),
    max_HCO3 = max(HCO3, na.rm = TRUE),
    min_CO3 = min(CO3, na.rm = TRUE),
    max_CO3 = max(CO3, na.rm = TRUE),
    min_DIC = min(DIC, na.rm = TRUE),
    max_DIC = max(DIC, na.rm = TRUE),
    min_TA = min(TA, na.rm = TRUE),
    max_TA = max(TA, na.rm = TRUE),
    min_AragSat = min(AragSat, na.rm = TRUE),
    max_AragSat = max(AragSat, na.rm = TRUE)
  )
```

Plot data and do stats for all parameters

Temperature 
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, Temperature, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(Temperature ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(Temperature ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, normal distribution 

# Plot
temp_plot <- ggplot(data, aes(x = Treatment, y = Temperature, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  ylab(expression(bold(paste("Temperature (°C)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  #theme(axis.text.x = element_blank()) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = 0.5, y_position = c(30, 30)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(32, 32)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(31.5, 31.5)); temp_plot
```

Salinity 
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, Salinity, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(Salinity ~ Treatment, data = data)
summary(res.aov) # no significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(Salinity ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue < 0.05, distribution is not normal


# Transform data with log
res.aov <- aov(log(Salinity) ~ Treatment, data = data)
summary(res.aov) # no significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(log(Salinity) ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue < 0.05, distribution is not normal


# Transform data with sqrt
res.aov <- aov(sqrt(Salinity) ~ Treatment, data = data)
summary(res.aov) # no significant differences between treatments
TukeyHSD(res.aov)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(sqrt(Salinity) ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue < 0.05, distribution is not normal


# Transform data with inverse
res.aov <- aov((1/Salinity) ~ Treatment, data = data)
summary(res.aov) # no significant differences between treatments
TukeyHSD(res.aov)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest((1/Salinity) ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue < 0.05, distribution is not normal

# Conduct non-parametric test 
kruskal.test(Salinity ~ Treatment, data = data) # no significance 
dunn.test(data$Salinity, g = data$Treatment, method = "bonferroni") # I specified the Bonferroni method, otherwise the default method  is no adjustment for multiple comparisons

# Plot
sal_plot <- ggplot(data, aes(x = Treatment, y = Salinity, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  ylab(expression(bold(paste("Salinity (psu)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  #theme(axis.text.x = element_blank()) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = -0.5, y_position = c(35.8, 35.8)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = -0.5, y_position = c(36, 36)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = -0.5, y_position = c(36.3, 36.3)); sal_plot
```

pH total 
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, pH.Total, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(pH.Total ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(pH.Total ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, normal distribution 

# Plot
pH_plot <- ggplot(data, aes(x = Treatment, y = pH.Total, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  ylab(expression(bold(paste("pH (Total)")))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  #theme(axis.text.x = element_blank()) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = 0.5, y_position = c(8,8)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(8.2,8.2)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(8.1, 8.1)); pH_plot
```

CO2
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, CO2, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(CO2 ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(CO2 ~ Treatment, data = data) # pvalue < 0.05, variance is NOT homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, normal distribution 

# Transform data with log
res.aov <- aov(log(CO2) ~ Treatment, data = data)
summary(res.aov) # no significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(log(CO2) ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, distribution is normal

# Move forward with log(CO2), as it meets anova assumptions 
data$CO2_log <- log(data$CO2)

# Plot
CO2_plot <- ggplot(data, aes(x = Treatment, y = CO2, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  #ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  ylab(expression(bold("CO"[2] ~(μmol ~ kg^-1)))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  #theme(axis.text.x = element_blank()) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = 0.5, y_position = c(30,30)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(46.5,46.5)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(44.7,44.7)); CO2_plot

# Do I include the log value in the plot or the original value?
```

pCO2
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, pCO2, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(pCO2 ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(pCO2 ~ Treatment, data = data) # pvalue < 0.05, variance is NOT homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, normal distribution 

# Transform data with log
res.aov <- aov(log(pCO2) ~ Treatment, data = data)
summary(res.aov) # no significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(log(pCO2) ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, distribution is normal

# Move forward with log(pCO2), as it meets anova assumptions 
data$pCO2_log <- log(data$pCO2)

# Plot data 
pCO2_plot <- ggplot(data, aes(x = Treatment, y = pCO2, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  #ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  ylab(expression(bold("pCO"[2] ~(μmol ~ kg^-1)))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  #theme(axis.text.x = element_blank()) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = 0.5, y_position = c(1100,1100)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(1950,1950)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(1850,1850)); pCO2_plot
```

HCO3
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, HCO3, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(HCO3 ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(HCO3 ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, normal distribution 

# Plot data 
HCO3_plot <- ggplot(data, aes(x = Treatment, y = HCO3, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  #ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  ylab(expression(bold("HCO"[3] ~(μmol ~ kg^-1)))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = 0.5, y_position = c(1935,1935)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(2040,2040)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(2015,2015)); HCO3_plot
```

CO3
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, CO3, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(CO3 ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(CO3 ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, normal distribution 

# Plot data 
CO3_plot <- ggplot(data, aes(x = Treatment, y = CO3, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  #ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  ylab(expression(bold("CO"[3] ~(μmol ~ kg^-1)))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = 0.5, y_position = c(185,185)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(195,195)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(140,140)); CO3_plot
```

DIC
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, DIC, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(DIC ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(DIC ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, normal distribution 

# Plot data 
DIC_plot <- ggplot(data, aes(x = Treatment, y = DIC, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  #ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  ylab(expression(bold("DIC" ~(μmol ~ kg^-1)))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = 0.5, y_position = c(2075,2075)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(2150,2150)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(2130,2130)); DIC_plot
```

TA
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, TA, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(TA ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(TA ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue < 0.05, distribution is NOT normal 

# Transform data with log
res.aov <- aov(log(TA) ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(log(TA) ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue < 0.05,distribution is NOT normal

# Transform data with sqrt
res.aov <- aov(sqrt(TA) ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(sqrt(TA) ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue < 0.05,distribution is NOT normal

# Transform data with inverse
res.aov <- aov((1/TA) ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
TukeyHSD(res.aov)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(sqrt(1/TA) ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue < 0.05,distribution is NOT normal

# Conduct non-parametric test
kruskal.test(TA ~ Treatment, data = data) # significant differences between treatments 
dunn.test(data$TA, g = data$Treatment, method = "bonferroni") # I specified the Bonferroni method, otherwise the default method  is no adjustment for multiple comparisons

# Plot data 
TA_plot <- ggplot(data, aes(x = Treatment, y = TA, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  #ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  ylab(expression(bold("Total Alkalinity" ~(μmol ~ kg^-1)))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=T, vjust = -0.5, y_position = c(2205,2205), annotations = "NS.") +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(2225,2225), annotations = "**") +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(2220,2220), annotations = "**"); TA_plot
```

Aragonite saturation
```{r}
# Check for outliers
outlier.plot <- ggbetweenstats(data, Treatment, AragSat, outlier.tagging = TRUE); outlier.plot # no major outliers 

# Test for differences in temperature by treatment with one-way ANOVA
res.aov <- aov(AragSat ~ Treatment, data = data)
summary(res.aov) # significant differences between treatments
tukey <- glht(res.aov, linfct = mcp(Treatment = "Tukey"))
summary(tukey)

## Check ANOVA assumption of homogeneity of variance 
plot(res.aov, 1) 
leveneTest(AragSat ~ Treatment, data = data) # pvalue > 0.05, variance is homogeneous 

## Check ANOVA assumption of normally distributed
plot(res.aov, 2)
aov_residuals <- residuals(object = res.aov)
shapiro.test(x = aov_residuals) # pvalue > 0.05, normal distribution 

# Plot data 
Arag_plot <- ggplot(data, aes(x = Treatment, y = AragSat, fill = Treatment)) +
  geom_boxplot(color = "black") +
  #geom_point(aes(fill=Treatment, group=Treatment), colour="black", pch = 21, size=4, position = position_jitterdodge(0.3), alpha=0.9) + 
  #stat_compare_means(method = "anova", label.y = 32) +
  #stat_compare_means(comparisons = my_comparisons, method = "t.test") +
  #scale_fill_manual(values = c("lightblue", "lightgreen", "pink")) +
  scale_fill_manual(values = wes_palette("GrandBudapest1", n=3)) +
  #ylab(expression("Cell Density" ~(cells ~cm^-2))) +
  ylab(expression(bold("Ω"[Aragonite]))) +
  xlab("") +
  theme_classic() + 
  theme(axis.text = element_text(size=12, color="black"), 
        axis.title=element_text(size=12, color="black", face="bold")) +
  theme(legend.position = "none") +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "Mid")), map_signif_level=TRUE, vjust = 0.5, y_position = c(3,3)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Control", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(3.2,3.2)) +
  geom_signif(stat = "signif", position = "identity", comparisons = list(c("Mid", "High")), map_signif_level=TRUE, vjust = 0.5, y_position = c(2.3,2.3)); Arag_plot
```

Save plots
```{r}
all_plots<-plot_grid(temp_plot, sal_plot, pH_plot, CO2_plot, pCO2_plot, HCO3_plot, CO3_plot, DIC_plot, TA_plot, Arag_plot, nrow=2, ncol=5, label_y=1, labels=c("A", "B", "C", "D", "E", "F", "G", "H", "I", "J"), label_size=15); all_plots

ggsave(all_plots, file="../output/CarbChem/CarbChem_panel.png", width=25, height=10)
ggsave(all_plots, file="../output/CarbChem/CarbChem_panel.pdf", width=25, height=10)
```

Summarize data
```{r}
summary_data <- data %>%
  group_by(Treatment) %>%
  summarise(across(c(Salinity, Temperature, pH.Total, CO2, pCO2, HCO3, CO3, DIC, TA, AragSat, ), 
                   list(mean = mean, std_err = ~sd(.)/sqrt(length(.)))))
summary_data

write.csv(summary_data, "../output/CarbChem/CarbChem_summary.csv")
```

Make summary table for manuscript. Read data in 
```{r}
df <- read.csv("../output/CarbChem/CarbChem_summary.csv")
```

Round data so there is only 2 decimal points
```{r}
df <- df %>%
  mutate(across(contains("_mean") | contains("_std_err"), ~ round(., 2))) #%>%
  #mutate(across(contains("_mean"), ~ paste0(., "±")))
```

Concatenate "_std_err" values to corresponding "_mean" columns
```{r}
mean_columns <- grep("_mean", names(df), value = TRUE)
std_err_columns <- grep("_std_err", names(df), value = TRUE)

for (std_err_col in std_err_columns) {
  mean_col <- str_replace(std_err_col, "_std_err", "_mean")
  df[[mean_col]] <- paste0(df[[mean_col]], " ± ", df[[std_err_col]])
}
```

Drop columns with "_std_err" in their names
```{r}
df <- df %>%
  dplyr::select(-contains("_std_err")) %>%
  dplyr::select(-X)
```

Edit column names so they are appropriate for manuscript table 
```{r}
colnames(df)

df <- df %>%
  rename("Salinity (psu)" = "Salinity_mean",
         "Temperature (°C)" = "Temperature_mean",
         "Total pH" = "pH.Total_mean",
         "CO2 (μmol kg-1)" = "CO2_mean",
         "pCO2 (μmol kg-1)" = "CO2_mean",
         "HCO3 (μmol kg-1)" = "HCO3_mean",
         "CO3 (μmol kg-1)" = "CO3_mean",
         "DIC (μmol kg-1)" = "DIC_mean",
         "Total Alkalinity (μmol kg-1)" = "TA_mean",
         "Aragonite Saturation State" = "AragSat_mean"
         )

df <- df %>%
  rename(
    "Salinity (psu)" = Salinity_mean,
    "Temperature (\u00B0C)" = Temperature_mean,  # Using Unicode escape sequence for degree symbol
    "Total pH" = pH.Total_mean,
    "CO\u2082 (μmol kg\u207B\u00B9)" = CO2_mean,  # Using Unicode escape sequences for subscript 2 and superscript -1
    "pCO\u2082 (μmol kg\u207B\u00B9)" = pCO2_mean,  # Using Unicode escape sequences for subscript 2 and superscript -1
    "HCO\u2083 (μmol kg\u207B\u00B9)" = HCO3_mean,  # Using Unicode escape sequences for subscript 3 and superscript -1
    "CO\u2083 (μmol kg\u207B\u00B9)" = CO3_mean,  # Using Unicode escape sequences for subscript 3 and superscript -1
    "DIC (μmol kg\u207B\u00B9)" = DIC_mean,  # Using Unicode escape sequence for superscript -1
    "Total Alkalinity (μmol kg\u207B\u00B9)" = TA_mean,  # Using Unicode escape sequence for superscript -1
    "Aragonite Saturation State" = AragSat_mean
  )
```

Make table
```{r}
wes_palette = c("#F1BB7B", "#FD6467", "#5B1A18")

kbl(df) %>%
  kable_styling(full_width = F, position = "left") %>%
  #kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(1, bold = T) %>%
  row_spec(0, bold = T)

kbl(df) %>%
  kable_styling(full_width = F, position = "left") %>%
  #kable_classic(full_width = F, html_font = "Cambria") %>%
  column_spec(1, bold = T) %>%
  row_spec(0, bold = T) %>% 
  # row_spec(1, background = wes_palette[1]) %>% 
  # row_spec(2, background = wes_palette[2]) %>% 
  # row_spec(3, background = wes_palette[3])
  save_kable("../output/CarbChem/CarbonateChemistryTable.png")
```

The output png file still looks very bad. Need to figure out how to save in higher quality. 

